# Holy Sheet 开发计划与任务

> 版本：1.0  
> 创建日期：2026-01-12  
> 状态：规划中

---

## 概述

本文档详细定义了 Holy Sheet 项目从 Phase 0 到 Phase 8 的开发任务分解，包含任务描述、实现要点、依赖关系、工时估算和测试要求。

### 工时估算说明

- **S (Small)**：1-2 小时
- **M (Medium)**：2-4 小时
- **L (Large)**：4-8 小时
- **XL (Extra Large)**：1-2 天

---

## Phase 0: 基础设施

**目标**：搭建项目骨架，确立开发规范和工具链  
**预计工时**：3-4 天  
**里程碑**：M0 - 项目可构建、可测试、CI 通过

### 0.1 项目初始化

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 0.1.1 | 创建 GitHub 仓库，初始化 README、LICENSE (MIT) | S | - |
| 0.1.2 | 初始化 pnpm workspace，创建 pnpm-workspace.yaml | S | 0.1.1 |
| 0.1.3 | 配置根目录 TypeScript (tsconfig.json)，启用 strict 模式 | S | 0.1.2 |
| 0.1.4 | 配置 ESLint + Prettier，添加 .editorconfig | M | 0.1.3 |
| 0.1.5 | 添加 .gitignore，配置 husky + lint-staged | S | 0.1.4 |

**实现要点**：
- TypeScript 使用 `"strict": true`，`"noUncheckedIndexedAccess": true`
- ESLint 使用 `@typescript-eslint` 推荐配置
- Prettier 配置：单引号、无分号、2 空格缩进

**测试要求**：
- `pnpm install` 成功
- `pnpm lint` 无错误

---

### 0.2 包结构搭建

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 0.2.1 | 创建 packages/core 目录结构，配置 package.json | M | 0.1.5 |
| 0.2.2 | 配置 tsdown 构建，输出 ESM + CJS + 类型定义 | M | 0.2.1 |
| 0.2.3 | 创建 packages/formula 骨架 | S | 0.2.2 |
| 0.2.4 | 创建 packages/clipboard 骨架 | S | 0.2.2 |
| 0.2.5 | 创建 packages/xlsx 骨架 | S | 0.2.2 |
| 0.2.6 | 创建 packages/playground（Vite + Vue/React） | M | 0.2.2 |

**目录结构**：
```
packages/
├── core/
│   ├── src/
│   │   ├── model/
│   │   ├── layout/
│   │   ├── render/
│   │   ├── event/
│   │   ├── command/
│   │   ├── plugin/
│   │   └── index.ts
│   ├── package.json
│   └── tsconfig.json
├── formula/
├── clipboard/
├── xlsx/
└── playground/
```

**实现要点**：
- 每个包的 package.json 配置 `exports` 字段
- tsdown 配置 `splitting: false`，避免 chunk 问题
- playground 使用 Vite + Vue 3 或 React

**测试要求**：
- `pnpm build` 所有包成功
- 输出体积符合预算

---

### 0.3 测试与文档

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 0.3.1 | 配置 Vitest，添加示例测试 | M | 0.2.2 |
| 0.3.2 | 配置 Playwright E2E 测试框架 | M | 0.2.6 |
| 0.3.3 | 配置覆盖率报告 (c8/istanbul) | S | 0.3.1 |
| 0.3.4 | 初始化 VitePress 文档站点 | M | 0.2.2 |
| 0.3.5 | 配置 API 文档自动生成 (TypeDoc) | M | 0.3.4 |

**实现要点**：
- Vitest 配置 `globals: true`，支持 jsdom 环境
- Playwright 配置多浏览器测试（Chrome、Firefox、Safari）
- VitePress 配置侧边栏、搜索、主题

**测试要求**：
- `pnpm test` 通过示例测试
- `pnpm docs:dev` 文档站点正常运行

---

### 0.4 CI/CD

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 0.4.1 | 创建 GitHub Actions 测试工作流 | M | 0.3.1 |
| 0.4.2 | 创建构建工作流，检查包体积 | M | 0.4.1 |
| 0.4.3 | 配置自动发布流程 (changesets) | M | 0.4.2 |
| 0.4.4 | 配置文档站点自动部署 (GitHub Pages) | S | 0.3.4 |

**实现要点**：
- 测试工作流在 push 和 PR 时触发
- 包体积检查使用 `bundlesize` 或自定义脚本
- changesets 管理版本和 CHANGELOG

**测试要求**：
- PR 触发 CI 检查
- 主分支合并后自动发布（可选）

---

## Phase 1: 核心数据层

**目标**：实现完整的数据模型  
**预计工时**：5-7 天  
**依赖**：Phase 0 完成

### 1.1 基础类型定义

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 1.1.1 | 定义 CellValue、CellType 类型 | S | - |
| 1.1.2 | 定义 CellData 接口 | S | 1.1.1 |
| 1.1.3 | 定义 CellStyle、TextStyle、BorderStyle 接口 | M | - |
| 1.1.4 | 定义 RichTextData、TextRun 接口 | S | 1.1.3 |
| 1.1.5 | 定义 MergeCell、FreezeConfig 接口 | S | - |

**实现要点**：
```typescript
// src/model/types.ts
type CellValue = string | number | boolean | null
type CellType = 'n' | 's' | 'b' | 'd' | 'e'
type StyleId = number

interface CellData {
  v?: CellValue
  s?: StyleId | CellStyle
  t?: CellType
  f?: string
  si?: string
  p?: RichTextData
  custom?: Record<string, unknown>
}
```

**测试要求**：
- 类型定义正确，无 TypeScript 错误
- 编写类型测试（使用 `expectTypeOf`）

---

### 1.2 Workbook 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 1.2.1 | 实现 Workbook 类基础结构 | M | 1.1.5 |
| 1.2.2 | 实现 Sheet 管理（addSheet、deleteSheet、getSheet） | M | 1.2.1 |
| 1.2.3 | 实现工作表顺序管理（moveSheet） | S | 1.2.2 |
| 1.2.4 | 实现活动 Sheet 切换 | S | 1.2.2 |
| 1.2.5 | 实现样式表管理（addStyle、getStyle） | M | 1.1.3 |

**实现要点**：
- sheets 使用 `Map<string, Sheet>`
- sheetOrder 数组维护顺序
- 生成唯一 sheet ID 使用 nanoid 或自增

**测试要求**：
- Sheet CRUD 操作正确
- 活动 Sheet 切换正确
- 样式添加去重正确

---

### 1.3 Sheet 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 1.3.1 | 实现 Sheet 类基础结构 | M | 1.2.1 |
| 1.3.2 | 实现 cellData 稀疏存储 | M | 1.3.1 |
| 1.3.3 | 实现单元格读写（getCell、setCell、clearCell） | M | 1.3.2 |
| 1.3.4 | 实现范围读写（getCellRange、setCellRange） | M | 1.3.3 |
| 1.3.5 | 实现行高/列宽配置存储 | S | 1.3.1 |

**实现要点**：
```typescript
// cellData 稀疏存储
cellData: Record<number, Record<number, CellData>>

getCell(row: number, col: number): CellData | null {
  return this.cellData[row]?.[col] ?? null
}

setCell(row: number, col: number, data: CellData): void {
  if (!this.cellData[row]) {
    this.cellData[row] = {}
  }
  this.cellData[row][col] = data
}
```

**测试要求**：
- 单元格读写正确
- 稀疏存储不创建空对象
- 100 万单元格读写性能 < 1s

---

### 1.4 MergeIndex 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 1.4.1 | 实现 MergeIndex 类基础结构 | M | 1.1.5 |
| 1.4.2 | 实现行索引构建 | M | 1.4.1 |
| 1.4.3 | 实现 getMergeAt 查询 | M | 1.4.2 |
| 1.4.4 | 实现 isMasterCell、isSlaveCell | S | 1.4.3 |
| 1.4.5 | 实现 getMergesInViewport 视口范围查询 | M | 1.4.2 |
| 1.4.6 | 实现 addMerge、removeMerge | M | 1.4.2 |

**实现要点**：
- rowIndex: `Map<number, MergeCell[]>` 按行建立索引
- getMergeAt 先查行索引，再遍历该行的合并

**测试要求**：
- 合并单元格查询正确
- 边界情况测试（跨多行多列）
- 视口查询性能测试

---

### 1.5 StylePool 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 1.5.1 | 实现 StylePool 类基础结构 | M | 1.1.3 |
| 1.5.2 | 实现样式哈希计算 | S | 1.5.1 |
| 1.5.3 | 实现样式去重（add 方法） | M | 1.5.2 |
| 1.5.4 | 实现样式合并（merge 方法） | S | 1.5.3 |

**实现要点**：
```typescript
private hash(style: CellStyle): string {
  return JSON.stringify(style, Object.keys(style).sort())
}
```

**测试要求**：
- 相同样式返回相同 ID
- 样式合并正确
- 大量样式添加性能测试

---

## Phase 2: 布局与渲染

**目标**：实现高性能的虚拟滚动和 Canvas 渲染  
**预计工时**：10-14 天  
**依赖**：Phase 1 完成  
**里程碑**：M1 - 静态表格可渲染

### 2.1 IndexMapper 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 2.1.1 | 定义 Segment 数据结构 | S | - |
| 2.1.2 | 实现 IndexMapper 类基础结构 | M | 2.1.1 |
| 2.1.3 | 实现 toPhysical（二分查找） | M | 2.1.2 |
| 2.1.4 | 实现 toLogical | M | 2.1.3 |
| 2.1.5 | 实现 insert/delete 操作 | L | 2.1.4 |
| 2.1.6 | 实现 compact 合并相邻段 | M | 2.1.5 |

**实现要点**：
- 初始状态：`[{ logicalStart: 0, physicalStart: 0, count: Infinity }]`
- toPhysical 使用二分查找，O(log k)
- insert/delete 后调用 compact 优化

**测试要求**：
- 索引转换正确
- 多次插入删除后状态正确
- 性能测试：10000 次操作 < 100ms

---

### 2.2 AccumulatorCache 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 2.2.1 | 实现 AccumulatorCache 类基础结构 | M | - |
| 2.2.2 | 实现分块累积计算 | L | 2.2.1 |
| 2.2.3 | 实现 getOffset 查询 | M | 2.2.2 |
| 2.2.4 | 实现 getIndexAtOffset（像素→索引） | L | 2.2.3 |
| 2.2.5 | 实现局部失效 invalidateFrom | M | 2.2.2 |
| 2.2.6 | 实现增量重建 rebuildFrom | M | 2.2.5 |

**实现要点**：
- BLOCK_SIZE = 1000
- blockAccum[i] = 第 0 ~ i*blockSize 行的总高度
- 查询：二分找块 + 块内线性累加

**测试要求**：
- 偏移量计算正确
- 像素→索引转换正确
- 100 万行查询性能 < 10ms

---

### 2.3 HiddenRanges 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 2.3.1 | 实现 HiddenRanges 类（Set 模式） | M | - |
| 2.3.2 | 实现区间模式存储 | M | 2.3.1 |
| 2.3.3 | 实现自动切换逻辑（阈值 100） | M | 2.3.2 |
| 2.3.4 | 实现 hideRange/showRange | S | 2.3.3 |

**测试要求**：
- 隐藏/显示状态正确
- 模式切换阈值正确
- 大量隐藏项内存优化

---

### 2.4 LayoutManager 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 2.4.1 | 实现 LayoutManager 类基础结构 | M | 2.1.6, 2.2.6, 2.3.4 |
| 2.4.2 | 实现 getRowHeight/getColWidth | S | 2.4.1 |
| 2.4.3 | 实现 getRowOffset/getColOffset | M | 2.4.1 |
| 2.4.4 | 实现 getCellAtPoint（像素→坐标） | M | 2.4.3 |
| 2.4.5 | 实现 getVisibleRange（视口范围） | M | 2.4.4 |
| 2.4.6 | 实现 setRowHeight/setColWidth | M | 2.4.1 |
| 2.4.7 | 实现 insertRows/deleteRows/insertCols/deleteCols | L | 2.4.1 |
| 2.4.8 | 实现 hideRows/showRows/hideCols/showCols | M | 2.4.1 |
| 2.4.9 | 实现事务（beginTransaction/endTransaction） | M | 2.4.7 |

**测试要求**：
- 坐标转换正确
- 视口范围计算正确
- 事务批量修改正确

---

### 2.5 Viewport 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 2.5.1 | 实现 Viewport 类基础结构 | M | 2.4.5 |
| 2.5.2 | 实现视口状态管理 | S | 2.5.1 |
| 2.5.3 | 实现缓冲区计算 | M | 2.5.2 |
| 2.5.4 | 实现滚动方向检测 | S | 2.5.2 |
| 2.5.5 | 实现 scrollToCell | M | 2.5.2 |

**测试要求**：
- 缓冲区预渲染正确
- 滚动到指定单元格正确

---

### 2.6 SheetRenderer 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 2.6.1 | 实现 SheetRenderer 类基础结构 | M | 2.5.5 |
| 2.6.2 | 实现网格线绘制 | M | 2.6.1 |
| 2.6.3 | 实现合并单元格 clearRect | M | 2.6.2 |
| 2.6.4 | 实现背景绘制（Path2D 批量） | L | 2.6.1 |
| 2.6.5 | 实现文本内容绘制 | L | 2.6.1 |
| 2.6.6 | 实现文本对齐、换行 | L | 2.6.5 |
| 2.6.7 | 实现边框绘制 | M | 2.6.1 |
| 2.6.8 | 实现富文本绘制 | L | 2.6.5 |

**实现要点**：
```typescript
// Path2D 批量绘制
const groups = new Map<string, Path2D>()
for (const cell of cells) {
  if (!groups.has(cell.bg)) {
    groups.set(cell.bg, new Path2D())
  }
  groups.get(cell.bg)!.rect(cell.x, cell.y, cell.width, cell.height)
}
for (const [color, path] of groups) {
  ctx.fillStyle = color
  ctx.fill(path)
}
```

**测试要求**：
- 渲染输出正确（视觉对比测试）
- 性能测试：10000 单元格渲染 < 50ms

---

### 2.7 DirtyRect 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 2.7.1 | 实现 DirtyRect 类基础结构 | M | - |
| 2.7.2 | 实现脏区域追踪 mark | S | 2.7.1 |
| 2.7.3 | 实现区域合并 mergeRegions | M | 2.7.2 |
| 2.7.4 | 实现 flush 增量重绘 | M | 2.7.3 |
| 2.7.5 | 实现 copy 模式滚动优化 | L | 2.7.4 |

**测试要求**：
- 脏区域合并正确
- 增量重绘只重绘脏区域

---

### 2.8 分层 Canvas

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 2.8.1 | 创建 Main Canvas | M | 2.6.8 |
| 2.8.2 | 创建 Selection Canvas | M | 2.8.1 |
| 2.8.3 | 创建 DOM Layer（滚动容器、输入框） | M | 2.8.1 |
| 2.8.4 | 实现层级管理和同步 | M | 2.8.3 |
| 2.8.5 | 实现 resize 处理 | S | 2.8.4 |

**测试要求**：
- 三层正确叠加
- 滚动同步正确
- resize 后重新渲染

---

## Phase 3: 交互系统

**目标**：实现完整的用户交互  
**预计工时**：10-14 天  
**依赖**：Phase 2 完成

### 3.1 EventEmitter 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 3.1.1 | 实现 EventEmitter 类 | M | - |
| 3.1.2 | 实现 on/off/emit | S | 3.1.1 |
| 3.1.3 | 实现 once | S | 3.1.2 |
| 3.1.4 | 定义事件类型常量 | S | 3.1.1 |

**测试要求**：
- 事件订阅/取消正确
- once 只触发一次

---

### 3.2 EventManager 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 3.2.1 | 实现 EventManager 类 | M | 3.1.4 |
| 3.2.2 | 实现 DOM 事件绑定 | M | 3.2.1 |
| 3.2.3 | 实现事件归一化（鼠标/触摸） | M | 3.2.2 |
| 3.2.4 | 实现坐标转换（viewport → cell） | M | 3.2.3 |

**测试要求**：
- DOM 事件正确转换为内部事件
- 坐标转换正确

---

### 3.3 InteractionManager 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 3.3.1 | 定义 InteractionState 类型 | S | - |
| 3.3.2 | 实现 InteractionManager 类 | M | 3.3.1 |
| 3.3.3 | 实现 idle 状态处理 | M | 3.3.2 |
| 3.3.4 | 实现 selecting 状态处理 | L | 3.3.3 |
| 3.3.5 | 实现 rowResizing/colResizing 状态 | L | 3.3.3 |
| 3.3.6 | 实现 editing 状态处理 | M | 3.3.3 |
| 3.3.7 | 实现 filling 状态处理 | L | 3.3.3 |

**测试要求**：
- 状态转换正确
- 无非法状态转换

---

### 3.4 SelectionManager 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 3.4.1 | 实现 SelectionManager 类 | M | 3.1.4 |
| 3.4.2 | 实现 setRange/addRange | M | 3.4.1 |
| 3.4.3 | 实现 extendTo（Shift+点击） | M | 3.4.2 |
| 3.4.4 | 实现 move（键盘导航） | M | 3.4.2 |
| 3.4.5 | 实现 expandForMerge（合并单元格扩展） | L | 3.4.2 |
| 3.4.6 | 实现选区渲染 | M | 3.4.5 |

**测试要求**：
- 多选区正确
- 合并单元格扩展正确

---

### 3.5 KeyboardHandler 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 3.5.1 | 实现 KeyboardHandler 类 | M | 3.4.4 |
| 3.5.2 | 实现方向键导航 | M | 3.5.1 |
| 3.5.3 | 实现 Tab/Enter 处理 | M | 3.5.1 |
| 3.5.4 | 实现 Ctrl+方向键（跳转到边缘） | M | 3.5.2 |
| 3.5.5 | 实现快捷键映射框架 | M | 3.5.1 |
| 3.5.6 | 实现插件钩子调用 | S | 3.5.5 |

**测试要求**：
- 导航正确
- 快捷键触发正确

---

### 3.6 TouchHandler 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 3.6.1 | 实现 TouchHandler 类 | M | 3.2.3 |
| 3.6.2 | 实现点击/双击识别 | M | 3.6.1 |
| 3.6.3 | 实现长按识别 | S | 3.6.1 |
| 3.6.4 | 实现滑动识别 + 惯性滚动 | L | 3.6.1 |
| 3.6.5 | 实现双指缩放 | L | 3.6.1 |

**测试要求**：
- 手势识别正确
- 惯性滚动平滑

---

### 3.7 AutoScroller 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 3.7.1 | 实现 AutoScroller 类 | M | - |
| 3.7.2 | 实现边缘检测 | M | 3.7.1 |
| 3.7.3 | 实现速度计算（距离→速度） | M | 3.7.2 |
| 3.7.4 | 实现动画循环 | M | 3.7.3 |

**测试要求**：
- 拖拽到边缘触发滚动
- 速度随距离变化

---

### 3.8 CellEditor 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 3.8.1 | 实现 CellEditor 类 | M | - |
| 3.8.2 | 实现输入框创建和定位 | M | 3.8.1 |
| 3.8.3 | 实现 IME compositionstart/update/end 处理 | L | 3.8.2 |
| 3.8.4 | 实现值提交和取消 | M | 3.8.2 |
| 3.8.5 | 实现公式编辑模式（高亮引用） | L | 3.8.4 |

**测试要求**：
- IME 输入正确
- Enter 提交、Escape 取消

---

### 3.9 ContextMenu 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 3.9.1 | 实现 ContextMenu 类 | M | - |
| 3.9.2 | 实现菜单 DOM 渲染 | M | 3.9.1 |
| 3.9.3 | 实现内置菜单项 | M | 3.9.2 |
| 3.9.4 | 实现插件扩展接口 | M | 3.9.3 |
| 3.9.5 | 实现分组/分隔符 | S | 3.9.2 |
| 3.9.6 | 实现子菜单 | M | 3.9.2 |

**测试要求**：
- 菜单正确显示
- 菜单项点击触发正确事件

---

## Phase 4: 命令与历史

**目标**：实现命令模式，支持撤销/重做  
**预计工时**：7-10 天  
**依赖**：Phase 3 完成  
**里程碑**：M2 - 表格可交互可编辑

### 4.1 Command 定义

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 4.1.1 | 定义 Command 接口 | S | - |
| 4.1.2 | 定义 CommandResult 类型 | S | 4.1.1 |
| 4.1.3 | 定义 UndoData 类型 | S | 4.1.1 |
| 4.1.4 | 定义所有 CommandType | M | 4.1.1 |

---

### 4.2 CommandDispatcher 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 4.2.1 | 实现 CommandDispatcher 类 | M | 4.1.4 |
| 4.2.2 | 实现 register/execute | M | 4.2.1 |
| 4.2.3 | 实现 before/after 钩子 | M | 4.2.2 |
| 4.2.4 | 实现命令合并逻辑 | L | 4.2.2 |

**实现要点**：
- 命令合并：300ms 内同类型同位置命令合并
- 合并时更新最后一个 UndoData

**测试要求**：
- 命令执行正确
- 钩子调用顺序正确
- 命令合并正确

---

### 4.3 UndoStack 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 4.3.1 | 实现 undo/redo 栈 | M | 4.2.4 |
| 4.3.2 | 实现大小限制（100） | S | 4.3.1 |
| 4.3.3 | 实现分组撤销 | M | 4.3.1 |
| 4.3.4 | 实现 undo/redo 方法 | M | 4.3.3 |

**测试要求**：
- 撤销/重做正确
- 超过 100 个自动丢弃最老的

---

### 4.4 Transaction 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 4.4.1 | 实现 beginTransaction | M | 4.3.4 |
| 4.4.2 | 实现 commit | M | 4.4.1 |
| 4.4.3 | 实现 rollback | M | 4.4.1 |

**测试要求**：
- 事务内多命令作为一个撤销单元
- rollback 正确回滚

---

### 4.5 内置命令实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 4.5.1 | 实现 SET_CELL / SET_CELLS / CLEAR_CELLS | L | 4.4.3 |
| 4.5.2 | 实现 INSERT_ROWS / DELETE_ROWS | L | 4.5.1 |
| 4.5.3 | 实现 INSERT_COLS / DELETE_COLS | L | 4.5.2 |
| 4.5.4 | 实现 SET_ROW_HEIGHT / SET_COL_WIDTH | M | 4.5.1 |
| 4.5.5 | 实现 HIDE_ROWS / SHOW_ROWS / HIDE_COLS / SHOW_COLS | M | 4.5.1 |
| 4.5.6 | 实现 MERGE_CELLS / UNMERGE_CELLS | L | 4.5.1 |
| 4.5.7 | 实现 SET_STYLE | M | 4.5.1 |
| 4.5.8 | 实现 ADD_SHEET / DELETE_SHEET / RENAME_SHEET / MOVE_SHEET | L | 4.5.1 |

**测试要求**：
- 每个命令执行正确
- 每个命令撤销正确
- 插入删除后引用更新正确

---

## Phase 5: 插件系统

**目标**：实现灵活的插件架构  
**预计工时**：5-7 天  
**依赖**：Phase 4 完成

### 5.1 插件接口定义

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 5.1.1 | 定义 PluginManifest 接口 | S | - |
| 5.1.2 | 定义 Plugin 接口（所有钩子） | M | 5.1.1 |
| 5.1.3 | 定义 PluginContext 接口 | M | 5.1.2 |

---

### 5.2 PluginManager 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 5.2.1 | 实现 PluginManager 类 | M | 5.1.3 |
| 5.2.2 | 实现插件注册 install | M | 5.2.1 |
| 5.2.3 | 实现插件卸载 uninstall | M | 5.2.2 |
| 5.2.4 | 实现依赖解析 | L | 5.2.2 |
| 5.2.5 | 实现生命周期调用 | M | 5.2.4 |

**测试要求**：
- 安装/卸载正确
- 依赖检查正确

---

### 5.3 PluginContext 实现

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 5.3.1 | 实现 PluginContext 类 | M | 5.2.5 |
| 5.3.2 | 实现核心模块访问 | M | 5.3.1 |
| 5.3.3 | 实现状态存储 getState/setState | M | 5.3.1 |

---

### 5.4 钩子系统完善

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 5.4.1 | 实现数据钩子调用链 | M | 5.3.3 |
| 5.4.2 | 实现命令钩子调用链 | M | 5.4.1 |
| 5.4.3 | 实现渲染钩子调用链 | M | 5.4.2 |
| 5.4.4 | 实现交互钩子调用链 | M | 5.4.3 |

**测试要求**：
- 钩子调用顺序正确
- 钩子返回值处理正确

---

## Phase 6: 核心插件

**目标**：实现常用功能插件  
**预计工时**：14-21 天  
**依赖**：Phase 5 完成  
**里程碑**：M3 - 完整功能表格

### 6.1 @holy-sheet/clipboard

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 6.1.1 | 创建 clipboard 包结构 | S | - |
| 6.1.2 | 实现复制功能（内部格式） | L | 6.1.1 |
| 6.1.3 | 实现剪切功能 | M | 6.1.2 |
| 6.1.4 | 实现粘贴功能（内部格式） | L | 6.1.2 |
| 6.1.5 | 实现跨表格粘贴 | L | 6.1.4 |
| 6.1.6 | 实现纯文本格式支持 | M | 6.1.4 |
| 6.1.7 | 实现 HTML 格式支持 | L | 6.1.4 |
| 6.1.8 | 实现格式保留/仅粘贴值 | M | 6.1.4 |

**测试要求**：
- 内部复制粘贴正确
- 跨表格粘贴正确
- 从 Excel 粘贴解析正确

---

### 6.2 @holy-sheet/formula

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 6.2.1 | 创建 formula 包结构 | S | - |
| 6.2.2 | 实现公式词法分析器 | L | 6.2.1 |
| 6.2.3 | 实现公式语法分析器 | XL | 6.2.2 |
| 6.2.4 | 实现公式求值器 | L | 6.2.3 |
| 6.2.5 | 实现基础函数（SUM、AVERAGE、COUNT、MAX、MIN） | L | 6.2.4 |
| 6.2.6 | 实现逻辑函数（IF、AND、OR、NOT） | M | 6.2.4 |
| 6.2.7 | 实现文本函数（CONCAT、LEFT、RIGHT、LEN） | M | 6.2.4 |
| 6.2.8 | 实现查找函数（VLOOKUP、INDEX、MATCH） | L | 6.2.4 |
| 6.2.9 | 实现依赖追踪 | L | 6.2.4 |
| 6.2.10 | 实现增量计算 | L | 6.2.9 |
| 6.2.11 | 实现循环引用检测 | M | 6.2.9 |
| 6.2.12 | 实现公式插件钩子 | M | 6.2.10 |

**测试要求**：
- 公式解析正确
- 函数计算正确
- 循环引用检测正确
- 增量计算性能

---

### 6.3 @holy-sheet/history

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 6.3.1 | 创建 history 包结构 | S | - |
| 6.3.2 | 实现快捷键绑定（Ctrl+Z/Y） | M | 6.3.1 |
| 6.3.3 | 实现 Ctrl+Shift+Z（redo 备选） | S | 6.3.2 |

---

### 6.4 @holy-sheet/xlsx

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 6.4.1 | 创建 xlsx 包结构 | S | - |
| 6.4.2 | 集成 xlsx 解析库 | M | 6.4.1 |
| 6.4.3 | 实现导入解析（Sheet 数据） | L | 6.4.2 |
| 6.4.4 | 实现导入解析（样式映射） | L | 6.4.3 |
| 6.4.5 | 实现导入解析（合并单元格） | M | 6.4.3 |
| 6.4.6 | 实现导入解析（公式） | L | 6.4.3 |
| 6.4.7 | 实现导出生成（Sheet 数据） | L | 6.4.2 |
| 6.4.8 | 实现导出生成（样式映射） | L | 6.4.7 |
| 6.4.9 | 实现导出生成（合并单元格） | M | 6.4.7 |
| 6.4.10 | 实现导出生成（公式） | L | 6.4.7 |

**测试要求**：
- 导入导出往返测试
- 样式保真度测试
- 大文件性能测试

---

## Phase 7: 性能优化

**目标**：针对大数据量场景深度优化  
**预计工时**：10-14 天  
**依赖**：Phase 6 完成  
**里程碑**：M4 - 高性能版本

### 7.1 Worker 集成

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 7.1.1 | 实现 Worker 通信封装（postMessage/onMessage） | L | - |
| 7.1.2 | 实现公式计算 Worker | L | 7.1.1 |
| 7.1.3 | 实现排序 Worker | L | 7.1.1 |
| 7.1.4 | 实现筛选 Worker | L | 7.1.1 |
| 7.1.5 | 实现 Worker 任务调度 | M | 7.1.2 |

**测试要求**：
- Worker 计算正确
- 主线程不阻塞
- 公式计算 1000 个 < 100ms

---

### 7.2 渲染优化

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 7.2.1 | 实现字体测量缓存 | M | - |
| 7.2.2 | 实现 TextMetrics 缓存 | M | 7.2.1 |
| 7.2.3 | 实现 Path2D 对象池 | M | - |
| 7.2.4 | 优化绘制调用合并 | L | 7.2.3 |
| 7.2.5 | 实现层级合并策略 | M | 7.2.4 |

**测试要求**：
- 渲染性能提升 > 30%
- 内存占用不增加

---

### 7.3 内存优化

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 7.3.1 | 实现稀疏数据压缩 | L | - |
| 7.3.2 | 实现视口外数据卸载策略 | L | 7.3.1 |
| 7.3.3 | 实现样式池压缩 | M | - |
| 7.3.4 | 实现大数据分页加载 | L | 7.3.2 |

**测试要求**：
- 100 万单元格内存 < 200MB
- 卸载后可恢复

---

### 7.4 OffscreenCanvas（可选）

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 7.4.1 | 实现 OffscreenCanvas Worker | L | 7.1.5 |
| 7.4.2 | 实现主线程合成 | L | 7.4.1 |
| 7.4.3 | 实现帧同步 | L | 7.4.2 |

**测试要求**：
- 渲染帧率稳定 60fps
- 主线程响应 < 16ms

---

## Phase 8: 生态建设

**目标**：完善文档和示例，建设开发者生态  
**预计工时**：14-21 天  
**依赖**：Phase 7 完成  
**里程碑**：M5 - 正式发布 1.0

### 8.1 文档

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 8.1.1 | 完善 VitePress 站点结构 | M | - |
| 8.1.2 | 编写快速开始教程 | L | 8.1.1 |
| 8.1.3 | 编写基础用法教程 | L | 8.1.2 |
| 8.1.4 | 编写高级特性教程 | L | 8.1.3 |
| 8.1.5 | 编写插件开发教程 | L | 8.1.4 |
| 8.1.6 | 完善 API 文档（TypeDoc） | L | 8.1.1 |
| 8.1.7 | 编写 FAQ | M | 8.1.6 |
| 8.1.8 | 编写迁移指南 | M | 8.1.6 |

---

### 8.2 示例

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 8.2.1 | 创建基础表格示例 | M | - |
| 8.2.2 | 创建公式表格示例 | M | 8.2.1 |
| 8.2.3 | 创建大数据表格示例 | M | 8.2.1 |
| 8.2.4 | 创建自定义渲染示例 | L | 8.2.1 |
| 8.2.5 | 创建插件开发示例 | L | 8.2.1 |
| 8.2.6 | 创建 Excel 导入导出示例 | M | 8.2.1 |

---

### 8.3 框架适配

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 8.3.1 | 创建 @holy-sheet/react 封装 | L | - |
| 8.3.2 | 创建 @holy-sheet/vue 封装 | L | 8.3.1 |
| 8.3.3 | 创建 @holy-sheet/svelte 封装 | L | 8.3.1 |
| 8.3.4 | 编写各框架使用文档 | M | 8.3.3 |

**测试要求**：
- 各框架正确渲染
- 响应式更新正确

---

### 8.4 发布准备

| 任务 ID | 任务描述 | 工时 | 依赖 |
|---------|----------|------|------|
| 8.4.1 | 完善 CHANGELOG | M | - |
| 8.4.2 | 完善 README | M | 8.4.1 |
| 8.4.3 | 创建 CONTRIBUTING 指南 | M | 8.4.2 |
| 8.4.4 | 配置 npm 发布 | S | 8.4.3 |
| 8.4.5 | 发布 1.0.0 版本 | S | 8.4.4 |

---

## 里程碑检查点

| 里程碑 | 阶段 | 检查项 |
|--------|------|--------|
| **M0** | Phase 0 | 项目可构建、可测试、CI 通过 |
| **M1** | Phase 1-2 | 100 万单元格渲染 < 1s、滚动 60fps |
| **M2** | Phase 3-4 | 选区/编辑/撤销重做正常工作 |
| **M3** | Phase 5-6 | 公式计算正确、剪贴板工作、Excel 导入导出 |
| **M4** | Phase 7 | 性能基准全部达标 |
| **M5** | Phase 8 | 文档完善、示例齐全、npm 发布成功 |

---

## 性能基准

| 场景 | 目标 | 验收方法 |
|------|------|----------|
| 首屏渲染（10000 单元格） | < 50ms | Performance API |
| 滚动帧率 | 60fps | Chrome DevTools |
| 100 万单元格加载 | < 1s | Performance API |
| 内存占用（100 万单元格） | < 200MB | Chrome Memory |
| 公式计算（1000 个） | < 100ms | Performance API |
| 排序（10 万行） | < 500ms | Performance API |

---

## 变更记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-12 | 1.0 | 初始版本 |
